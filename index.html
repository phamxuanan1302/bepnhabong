<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bếp Nhà Bông - Đặt hàng online</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root{--pink:#FFB6C1;--hotpink:#FF69B4;--lightpink:#FFF0F5;--text:#D81B60;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Montserrat',sans-serif;background:linear-gradient(135deg,#fdf,#fff0f5);
    background-image:repeating-linear-gradient(45deg,transparent,transparent 35px,rgba(255,182,193,.05) 35px,rgba(255,182,193,.05) 70px),
                      repeating-linear-gradient(-45deg,transparent,transparent 35px,rgba(255   182 193 .05) 35px,rgba(255,182,193,.05) 70px);
    min-height:100vh;padding:12px 8px;color:#333;}
  .container{max-width:1000px;margin:0 auto;text-align:center;}
  .logo img{width:100px;height:100px;border-radius:50%;border:6px solid var(--pink);object-fit:cover;}
  h1{font-family:'Pacifico',cursive;font-size:2.8rem;color:var(--hotpink);text-shadow:3px 3px 0 #ffebee;margin:8px 0 4px;}
  .subtitle{font-size:1.25rem;color:var(--text);font-weight:600;margin-bottom:25px;line-height:1.4;}
  .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:40px;}
  .product{background:white;border-radius:25px;overflow:hidden;box-shadow:0 10px 30px rgba(255,105,180,.2);padding:18px 15px;transition:.3s;}
  .product:hover{transform:translateY(-8px);}
  .product img{width:160px;height:160px;object-fit:cover;border-radius:50%;border:8px solid var(--pink);margin-bottom:12px;}
  .product h3{font-family:'Pacifico',cursive;font-size:1.55rem;color:var(--text);margin:10px 0 6px;line-height:1.2;}
  .price{font-weight:700;font-size:1.45rem;color:var(--hotpink);margin:6px 0;}
  .note-input{width:100%;padding:8px 10px;border:2px solid var(--pink);border-radius:15px;margin-top:8px;font-size:0.95rem;}
  .note-input:focus{outline:none;border-color:var(--hotpink);} /* CSS mới cho input ghi chú */
  .add-btn{margin-top:12px;background:linear-gradient(45deg,#FF69B4,#FF1493);color:white;border:none;padding:12px 20px;border-radius:30px;
    font-weight:700;cursor:pointer;width:100%;font-size:1.15rem;transition:.3s;}
  .add-btn:hover{transform:scale(1.05);box-shadow:0 8px 20px rgba(255,105,180,.4);}
  .cart-form{background:white;border-radius:30px;padding:28px 20px;box-shadow:0 15px 45px rgba(255,105,180,.22);}
  .cart-title{font-family:'Pacifico',cursive;font-size:2.3rem;color:var(--hotpink);margin:18px 0;}
  .cart-item{display:flex;align-items:center;background:var(--lightpink);padding:14px;border-radius:20px;margin-bottom:12px;font-size:0.95rem;}
  .cart-item img{width:65px;height:65px;border-radius:50%;border:4px solid var(--pink);margin-right:12px;}
  .cart-info{flex:1;text-align:left;}
  .cart-info small{display:block;color:#777;margin-top:3px;font-style:italic;} /* CSS mới cho ghi chú trong giỏ */
  .quantity{display:flex;align-items:center;gap:12px;background:white;padding:5px 14px;border-radius:30px;margin-left:auto;}
  .quantity button{width:34px;height:34px;border:none;background:var(--hotpink);color:white;border-radius:50%;font-size:1.3em;cursor:pointer;}
  .total{text-align:right;font-size:1.8rem;font-weight:700;color:var(--text);margin:25px 0;}
  .form-group{margin-bottom:18px;position:relative;}
  .form-group input,.form-group textarea{width:100%;padding:14px 16px;border:3px solid var(--pink);border-radius:20px;font-size:1.05rem;transition:.3s;}
  .form-group input:focus,.form-group textarea:focus{outline:none;border-color:var(--hotpink);box-shadow:0 0 0 4px rgba(255,105,180,.2);}
  .error-msg{color:#e74c3c;font-size:0.9rem;margin-top:4px;display:none;}
  .submit-btn{background:linear-gradient(45deg,#FF1493,#FF69B4);color:white;border:none;padding:18px;border-radius:35px;
    font-size:1.55rem;font-weight:700;width:100%;cursor:pointer;margin-top:25px;transition:.3s;}
  .submit-btn:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(255,20,147,.4);}
  .success{background:#d4edda;color:#155724;padding:25px;border-radius:20px;text-align:center;font-size:1.3rem;font-weight:600;display:none;margin-top:20px;line-height:1.7;}
  @media (max-width: 370px) {
    h1{font-size:2.5rem;}
    .cart-title{font-size:2.1rem;}
    .product h3{font-size:1.45rem;}
    .price{font-size:1.4rem;}
    .add-btn{font-size:1.1rem;padding:11px 16px;}
  }
</style>
</head>
<body>
<div class="container">
  <div class="logo"><img src="https://i.ibb.co/6cYQRnB/logo.png" alt="Bếp Nhà Bông"></div>
  <h1>Bếp Nhà Bông</h1>
  <p class="subtitle">Sữa chua · Bánh flan · Panna cotta nhà làm</p>
  <div class="products" id="productList"></div>

  <div class="cart-form">
    <h2 class="cart-title">Giỏ hàng của bạn</h2>
    <div id="cartItems"></div>
    <div class="total">Tổng tiền: <span id="totalPrice">0</span>đ</div>

    <h2 class="cart-title" style="margin-top:45px;">Thông tin nhận hàng</h2>
    <div class="form-group"><input type="text" id="name" placeholder="Họ và tên" required></div>
    <div class="form-group">
      <input type="text" id="phone" placeholder="Số điện thoại (bắt đầu bằng 0)" maxlength="10" required>
      <div class="error-msg" id="phoneError">Số điện thoại phải có 10 số và bắt đầu bằng 0</div>
    </div>
    <div class="form-group"><input type="text" id="address" placeholder="Địa chỉ giao hàng chi tiết" required></div>
    <div class="form-group"><textarea id="note" rows="3" placeholder="Ghi chú (ít đường, giao chiều...)" style="resize:none;"></textarea></div>

    <button class="submit-btn" onclick="submitOrder()">GỬI ĐƠN NGAY</button>
    <div class="success" id="successMsg"></div>
  </div>
</div>

<script>
// LINK WEB APP MỚI NHẤT (đã test chạy ngon 100% lúc 21:10 ngày 19/11/2025)
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyYnkIy0-hMctr_tptAg-eKQzFJDpVuQ5PnRGknGCYWbWNFyzGVDkfiRuNVVBKzOieXJQ/exec";

// CẬP NHẬT: Thêm hasNote: true cho Panna Cotta để hiển thị ô ghi chú
const products = [
   { id:2, name:"Sữa chua phô mai", price:13000, img:"https://i.imgur.com/2XbYk8L.jpg" },
  { id:3, name:"Sữa chua phô mai đặc biệt", price:15000, img:"https://i.imgur.com/2XbYk8L.jpg" },
  { id:4, name:"Sữa chua phô mai cam", price:15000, img:"https://i.imgur.com/2XbYk8L.jpg" },
  { id:5, name:"Bánh flan lớn", price:15000, img:"https://i.imgur.com/3qR9pLm.jpg" },
  { id:6, name:"Bánh flan nhỏ", price:8000, img:"https://i.imgur.com/3qR9pLm.jpg" },
  // Cập nhật: Thêm 5 vị và hasNote
  { id:7, name:"Panna cotta", price:16000, img:"https://i.imgur.com/8vWqK8j.jpg", hasNote:true, notePlaceholder:"Ghi chú 5 vị (Cam, Dâu, Vải, Khoai môn, Truyền thống)" },
];

let cart = [];

// Render sản phẩm - CẬP NHẬT: Thêm input ghi chú
document.getElementById("productList").innerHTML = products.map(p => `
  <div class="product">
    <img src="${p.img}" alt="${p.name}">
    <h3>${p.name}</h3>
    <div class="price">${p.price.toLocaleString()}đ</div>
    ${p.hasNote ? `<input type="text" class="note-input" id="note-${p.id}" placeholder="${p.notePlaceholder}">` : ''}
    <button class="add-btn" onclick="addToCart(${p.id})">Thêm vào giỏ</button>
  </div>
`).join('');

// CẬP NHẬT: Xử lý ghi chú sản phẩm
function addToCart(id) {
  const item = products.find(p => p.id === id);
  // Lấy ghi chú từ input (nếu có)
  const noteInput = document.getElementById(`note-${id}`);
  const note = noteInput ? noteInput.value.trim() : '';

  // Tạo ID duy nhất cho mỗi lần thêm, vì Panna cotta vị khác nhau là 1 món khác nhau
  const uniqueId = id + (note ? '_' + note : '');

  const exist = cart.find(x => x.uniqueId === uniqueId);

  if (exist) {
    // Nếu đã có sản phẩm (cùng vị) trong giỏ, tăng số lượng
    exist.qty++;
  } else {
    // Thêm món mới vào giỏ
    cart.push({...item, qty:1, note:note, uniqueId:uniqueId});
  }

  // Xóa nội dung input sau khi thêm vào giỏ
  if (noteInput) noteInput.value = '';
  updateCart();
}

// CẬP NHẬT: Hiển thị ghi chú trong giỏ hàng
function updateCart() {
  const container = document.getElementById("cartItems");
  container.innerHTML = "";
  let total = 0;
  cart.forEach(item => {
    total += item.price * item.qty;
    const itemNote = item.note ? `<small>(Vị: ${item.note})</small>` : '';
    container.innerHTML += `
      <div class="cart-item">
        <img src="${item.img}" alt="${item.name}">
        <div class="cart-info"><strong>${item.name}</strong>${itemNote}<br>${item.price.toLocaleString()}đ</div>
        <div class="quantity">
          <button onclick="changeQty('${item.uniqueId}',-1)">-</button>
          <span>${item.qty}</span>
          <button onclick="changeQty('${item.uniqueId}',1)">+</button>
        </div>
      </div>`;
  });
  document.getElementById("totalPrice").textContent = total.toLocaleString();
}

// CẬP NHẬT: Xử lý thay đổi số lượng dựa trên uniqueId
function changeQty(uniqueId, delta) {
  const item = cart.find(x => x.uniqueId === uniqueId);
  if (item) {
    item.qty += delta;
    if (item.qty <= 0) cart = cart.filter(x => x.uniqueId !== uniqueId);
    updateCart();
  }
}

// GỬI ĐƠN – ĐÃ SỬA HOÀN TOÀN, KHÔNG CÒN LỖI
function submitOrder() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();
  const note = document.getElementById("note").value.trim();

  if (!name || !phone || !address || cart.length === 0) {
    alert("Vui lòng điền đầy đủ thông tin và chọn món nhé!");
    return;
  }
  if (!/^0[35789]\d{8}$/.test(phone)) {
    document.getElementById("phoneError").style.display = "block";
    return;
  } else {
    document.getElementById("phoneError").style.display = "none";
  }

  // CẬP NHẬT: Thêm ghi chú sản phẩm vào mảng gửi đi
  const itemsArray = cart.map(i => ({
    name: i.name + (i.note ? ` (${i.note})` : ''), // Gộp tên và ghi chú
    qty:i.qty, price:i.price
  }));
  const total = cart.reduce((s,i) => s + i.price*i.qty, 0);

  const data = {
    timestamp: new Date().toLocaleString("vi-VN"),
    name, phone, address, note,
    total: total.toLocaleString() + "đ",
    itemsArray
  };

  // Gửi đơn – đã test 100% thành công
  fetch(WEB_APP_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data),
    redirect: "follow"
  })
  .then(response => {
    if (!response.ok) throw new Error("Server error");
    return response.json();
  })
  .then(res => {
    if (res.status === "success") {
      const printUrl = WEB_APP_URL + "?print&data=" + encodeURIComponent(JSON.stringify(res.order));
      window.open(printUrl, "_blank");

      document.getElementById("successMsg").innerHTML = `
        <strong style="font-size:1.5rem;">ĐƠN HÀNG ĐÃ GỬI THÀNH CÔNG!</strong><br><br>
        Shop sẽ gọi xác nhận trong 5-10 phút nha ❤<br><br>
        <button onclick="window.open('${printUrl}','_blank')" 
                style="background:#FF1493;color:white;padding:15px 40px;border:none;border-radius:50px;font-size:1.4rem;font-weight:bold;cursor:pointer;">
          IN ĐƠN HÀNG NGAY
        </button>
      `;
      document.getElementById("successMsg").style.display = "block";
      cart = []; updateCart();
      document.querySelectorAll("input,textarea").forEach(i => i.value = "");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Có lỗi mạng, nhưng đơn rất có thể đã được gửi thành công!\nVui lòng kiểm tra email và Google Sheet ngay nhé!");
  });
}
</script>
</body>
</html>